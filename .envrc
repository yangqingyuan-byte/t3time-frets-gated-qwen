#!/usr/bin/env bash
# 自动激活 conda 环境 TimeCMA_Qwen3
# 使用 direnv 工具：https://direnv.net/
# 安装方法: conda install -c conda-forge direnv
# 然后在 ~/.bashrc 或 ~/.zshrc 中添加: eval "$(direnv hook bash)" 或 eval "$(direnv hook zsh)"

# 设置 conda 环境路径
CONDA_ENV_NAME="TimeCMA_Qwen3"
CONDA_ENV_PATH="/root/anaconda3/envs/${CONDA_ENV_NAME}"

# 检查环境是否存在
if [ ! -d "$CONDA_ENV_PATH" ]; then
    echo "⚠ 警告: conda 环境 $CONDA_ENV_NAME 不存在"
    exit 1
fi

# 初始化 conda（用于获取 conda 命令）
if [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
    source "$HOME/anaconda3/etc/profile.d/conda.sh"
elif [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
    source "$HOME/miniconda3/etc/profile.d/conda.sh"
elif [ -f "/opt/conda/etc/profile.d/conda.sh" ]; then
    source "/opt/conda/etc/profile.d/conda.sh"
fi

# 导出 conda 环境变量（direnv 会捕获这些变量）
export CONDA_DEFAULT_ENV="$CONDA_ENV_NAME"
export CONDA_PREFIX="$CONDA_ENV_PATH"
export CONDA_PROMPT_MODIFIER="($CONDA_ENV_NAME) "
export CONDA_SHLVL="1"

# 将 conda 环境的 bin 目录添加到 PATH 最前面
export PATH="$CONDA_ENV_PATH/bin:$PATH"

# 注意：direnv 只能设置环境变量，不能直接修改 PS1 提示符
# 提示符的更新需要在 shell 配置文件中完成
# 如果提示符没有显示环境名称，可以通过以下命令验证环境已激活：
# echo $CONDA_DEFAULT_ENV 或 which python

echo "✓ 已自动激活 conda 环境: $CONDA_ENV_NAME"
