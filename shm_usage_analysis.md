# 共享内存使用情况分析与推荐配置

## 📊 当前共享内存使用情况

### 当前配置
- **GPU数量**: 8张
- **每张GPU并行数**: 1个实验
- **总进程数**: 8个训练进程

### 实际测量数据
```
共享内存总大小: 64 MB
共享内存已使用: 46 MB (71.9%)
共享内存可用: 18 MB
```

### 每个进程的共享内存占用
- **RssShmem（进程共享内存映射）**: 15.85 MB/进程
- **实际 /dev/shm 占用**: 5.75 MB/进程
- **8个进程总计**: 46 MB

**说明**: 
- RssShmem 包括所有共享内存映射（包括库文件等）
- 实际在 `/dev/shm` 中占用的主要是进程间通信的共享内存
- 当前每个训练进程实际占用约 **5.75 MB** 共享内存

---

## 🔮 推算：每张卡6个并行实验所需共享内存

### 计算过程

```
每张GPU并行数: 6个实验
总进程数: 8张GPU × 6个并行 = 48个进程
每个进程占用: 5.75 MB
总共享内存需求: 48 × 5.75 MB = 276 MB
```

### 推荐配置（考虑安全余量）

| 配置方案 | 共享内存大小 | 说明 |
|---------|------------|------|
| **最小配置** | 512 MB | 刚好满足需求，无余量 |
| **推荐配置** | **1 GB** | 有足够余量，推荐使用 |
| **保守配置** | 2 GB | 更安全，适合长期运行 |

### 详细计算

```python
# 基础需求
基础需求 = 48进程 × 5.75 MB = 276 MB

# 考虑安全余量（30%）
推荐大小 = 276 MB × 1.3 = 359 MB ≈ 0.35 GB

# 向上取整到GB
建议设置 = 1 GB
```

---

## 📈 不同并行数的共享内存需求对照表

| 每张GPU并行数 | 总进程数 | 基础需求 | 推荐配置 |
|-------------|---------|---------|---------|
| 1 | 8 | 46 MB | 512 MB |
| 2 | 16 | 92 MB | 512 MB |
| 3 | 24 | 138 MB | 512 MB |
| 4 | 32 | 184 MB | 512 MB |
| 5 | 40 | 230 MB | 512 MB |
| **6** | **48** | **276 MB** | **1 GB** |
| 7 | 56 | 322 MB | 1 GB |
| 8 | 64 | 368 MB | 1 GB |
| 10 | 80 | 460 MB | 1 GB |
| 12 | 96 | 552 MB | 1 GB |

---

## ✅ 最终建议

### 对于每张卡运行6个实验的场景：

**推荐设置**: `--shm-size=1g`

**理由**:
1. ✅ 基础需求 276 MB，1 GB 有 3.6 倍余量
2. ✅ 足够安全，不会因为临时峰值导致 OOM
3. ✅ 不会浪费太多系统内存
4. ✅ 便于记忆和管理

### 设置方法

```bash
# 方法1: docker run
docker run --shm-size=1g [其他参数] [镜像名]

# 方法2: docker-compose.yml
services:
  your_service:
    shm_size: '1gb'
```

---

## 🔍 验证方法

设置共享内存后，可以通过以下命令验证：

```bash
# 1. 查看共享内存大小
df -h /dev/shm

# 2. 查看进程数和共享内存使用
ps aux | grep train_frets_gated_qwen | grep -v grep | wc -l
df -h /dev/shm | tail -1 | awk '{print "使用率: " $5}'

# 3. 监控共享内存使用情况（实时）
watch -n 5 'df -h /dev/shm'
```

---

## 📝 注意事项

1. **实际占用可能波动**: 
   - 训练不同阶段（数据加载、前向传播、反向传播）的共享内存占用可能不同
   - 建议保留 2-3 倍余量

2. **其他进程的影响**:
   - 系统中其他进程也可能使用共享内存
   - 建议监控整体使用情况

3. **如果遇到 OOM**:
   - 检查共享内存使用: `df -h /dev/shm`
   - 如果使用率 > 80%，考虑增加大小或减少并行数

4. **性能考虑**:
   - 共享内存太小会导致进程无法创建，训练失败
   - 共享内存太大不会提升性能，只是浪费系统内存

---

## 📊 总结

**当前情况**: 8张GPU × 1个并行 = 46 MB 共享内存使用

**目标配置**: 8张GPU × 6个并行 = 276 MB 基础需求

**推荐设置**: **1 GB** (有足够安全余量)
